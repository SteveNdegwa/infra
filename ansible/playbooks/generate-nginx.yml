---
- name: Gather all domains that need SSL certificates
  set_fact:
    all_domains: >
      {{
        (app.environments.values() | list)
        | map(attribute='domain')
        | select('defined')
        | select('truthy')
        | list
        +
        (extra_domains | default([]))
        | map(attribute='domain')
        | select('defined')
        | select('truthy')
        | list
        | unique
      }}

- name: Obtain/renew Let's Encrypt certificates for all domains
  command: >
    certbot --nginx
    -d {{ all_domains | join(' -d ') }}
    --non-interactive
    --agree-tos
    --email admin@example.com
    --expand
  when: all_domains | length > 0
  ignore_errors: yes
  notify: Reload Nginx

- name: Create HTTP Basic Auth file if any extra domain needs protection
  htpasswd:
    path: /etc/nginx/.htpasswd
    name: admin
    password: "{{ nginx_basic_auth_password }}"
    crypt_scheme: bcrypt
    state: present
  vars:
    nginx_basic_auth_password: "{{ lookup('env', 'NGINX_BASIC_AUTH_PASSWORD') }}"
  when: >
    extra_domains is defined and
    extra_domains | selectattr('basic_auth', 'equalto', true) | list | length > 0
  no_log: true
  notify: Reload Nginx

- name: Generate Nginx configs for main app (prod and stage)
  loop:
    - { env: prod, domain: "{{ app.environments.prod.domain | default('') }}", port: "{{ app.environments.prod.port | default(8000) }}" }
    - { env: stage, domain: "{{ app.environments.stage.domain | default('') }}", port: "{{ app.environments.stage.port | default(8000) }}" }
  loop_control:
    loop_var: item
  template:
    src: ../../templates/nginx-site.j2
    dest: "/etc/nginx/sites-available/{{ app.name }}-{{ item.env }}.conf"
    mode: '0644'
  when: item.domain | length > 0
  notify: Reload Nginx

- name: Enable site for main app (prod and stage)
  loop:
    - { env: prod, domain: "{{ app.environments.prod.domain | default('') }}" }
    - { env: stage, domain: "{{ app.environments.stage.domain | default('') }}" }
  loop_control:
    loop_var: item
  file:
    src: "/etc/nginx/sites-available/{{ app.name }}-{{ item.env }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ app.name }}-{{ item.env }}.conf"
    state: link
  when: item.domain | length > 0
  notify: Reload Nginx

- name: Generate Nginx configs for extra tools (flower, grafana, etc.)
  loop: "{{ extra_domains | default([]) }}"
  loop_control:
    loop_var: item
  template:
    src: ../../templates/nginx-extra.j2
    dest: "/etc/nginx/sites-available/extra-{{ item.domain | replace('.', '-') }}.conf"
    mode: '0644'
  when: item.domain is defined and item.domain | length > 0
  notify: Reload Nginx

- name: Enable extra tool sites
  loop: "{{ extra_domains | default([]) }}"
  loop_control:
    loop_var: item
  file:
    src: "/etc/nginx/sites-available/extra-{{ item.domain | replace('.', '-') }}.conf"
    dest: "/etc/nginx/sites-enabled/extra-{{ item.domain | replace('.', '-') }}.conf"
    state: link
  when: item.domain is defined and item.domain | length > 0
  notify: Reload Nginx

- name: Test Nginx configuration
  command: nginx -t
  changed_when: false

- name: Reload Nginx
  service:
    name: nginx
    state: reloaded

---
- name: Remove default Nginx site symlink
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: Reload Nginx

- name: Remove default Nginx config file
  file:
    path: /etc/nginx/sites-available/default
    state: absent
  notify: Reload Nginx

- name: Find lingering default symlinks
  find:
    paths: /etc/nginx/sites-enabled
    patterns: 'default*'
  register: default_symlinks

- name: Delete lingering default symlinks
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ default_symlinks.files | default([]) }}"
  notify: Reload Nginx

- name: Gather all domains for SSL
  set_fact:
    all_domains: >
      {{
        (
          apps | default([])
          | map(attribute='environments')
          | map('dict2items')
          | flatten
          | map(attribute='value.domain')
          | select('defined')
          | select('truthy')
          | list
        )
        +
        (
          extra_domains | default([])
          | map(attribute='domain')
          | select('defined')
          | select('truthy')
          | list
        )
        | unique
      }}

- name: Ensure /var/www/letsencrypt exists
  file:
    path: /var/www/letsencrypt
    state: directory
    owner: www-data
    group: www-data
    mode: '0755'

- name: Obtain or renew SSL certificates for all domains
  command: >
    certbot --nginx
    -d {{ all_domains | join(' -d ') }}
    --non-interactive
    --agree-tos
    --email admin@mchangohub.com
    --expand
  when: all_domains | length > 0
  register: certbot
  changed_when: "'Congratulations' in (certbot.stdout | default(''))"
  failed_when: >
    certbot.rc != 0 and
    'no renewals were attempted' not in (certbot.stdout | default('')) and
    'Certificate not yet due for renewal' not in (certbot.stdout | default(''))
  notify: Reload Nginx

- name: Generate and enable Nginx configs for each app
  include_tasks: generate-nginx-app.yml
  loop: "{{ apps | default([]) }}"
  loop_control:
    loop_var: app

- name: Generate configs for extra tools
  template:
    src: ../templates/nginx-extra.j2
    dest: "/etc/nginx/sites-available/extra-{{ item.domain | replace('.', '-') }}.conf"
    mode: '0644'
  loop: "{{ extra_domains | default([]) }}"
  when: item.domain is defined and item.domain | length > 0
  notify: Reload Nginx

- name: Enable extra tool sites
  file:
    src: "/etc/nginx/sites-available/extra-{{ item.domain | replace('.', '-') }}.conf"
    dest: "/etc/nginx/sites-enabled/extra-{{ item.domain | replace('.', '-') }}.conf"
    state: link
  loop: "{{ extra_domains | default([]) }}"
  when: item.domain is defined and item.domain | length > 0
  notify: Reload Nginx

- name: Create HTTP Basic Auth file if required
  htpasswd:
    path: /etc/nginx/.htpasswd
    name: admin
    password: "{{ lookup('env', 'NGINX_BASIC_AUTH_PASSWORD') }}"
    crypt_scheme: bcrypt
    state: present
  when: >
    extra_domains is defined and
    extra_domains | selectattr('basic_auth', 'equalto', true) | list | length > 0
  no_log: true
  notify: Reload Nginx

- name: Test Nginx configuration
  command: nginx -t
  changed_when: false
  notify: Reload Nginx
